
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bakes-Villa - Artisan Cakes</title>
    
    <!-- FAVICON: Cupcake emoji favicon for browser tabs -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üßÅ</text></svg>">
    
    <!-- Load Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, setLogLevel } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // Expose Firebase objects globally for use in the main script block
        window.FirebaseServices = { 
            initializeApp, 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged, 
            getFirestore, 
            addDoc, 
            onSnapshot, 
            collection, 
            setLogLevel 
        };
        
        // Ensure the main script runs only after this module is loaded
        if (window.onloadCallback) {
            window.onloadCallback();
        }
    </script>

    <!-- Load Google Fonts: Playfair Display (for headings) and Inter (for body) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Configure Tailwind with the Healthful Organic Mode color palette -->
    <script>
        tailwind.config = {
            // NOTE: Dark mode is now controlled by the 'dark' class added to <html>
            darkMode: 'class', 
            theme: {
                extend: {
                    fontFamily: {
                        heading: ['"Playfair Display"', 'serif'], 
                        body: ['Inter', 'sans-serif'],          
                    },
                    colors: {
                        // Dynamic Colors mapped to CSS variables
                        'bg-page': 'var(--bg-page)',            
                        'bg-surface': 'var(--bg-surface)',      
                        'text-primary': 'var(--text-primary)',  
                        'text-main': 'var(--text-main)',        
                        'text-muted': 'var(--text-muted)',      
                        'border-light': 'var(--border-light)',  
                        'accent-green': '#4CAF50',              // WhatsApp Green (Static)
                    },
                    boxShadow: {
                        // Soft, subtle box shadows
                        'glow-primary': 'var(--shadow-glow)', 
                        'shadow-soft': 'var(--shadow-soft)',  
                    }
                }
            }
        }
    </script>
    <style>
        /*
        ---------------------------------------------
        COLOR VARIABLES - LIGHT MODE (DEFAULT)
        ---------------------------------------------
        */
        :root {
            /* Palette Colors */
            --color-primary-dark: #67795F;      /* Deep Sage */
            --color-surface-light: #E6D0C0;     /* Soft Rose/Beige */
            --color-bg-light: #FFF3DF;          /* Pale Cream */
            --color-secondary-light: #AFC;      /* Light Sage */

            /* Mappings */
            --bg-page: var(--color-bg-light);
            --bg-surface: var(--color-surface-light);
            --text-primary: var(--color-primary-dark);
            --text-main: #333333;
            --text-muted: #5C5C5C;
            --border-light: var(--color-secondary-light);

            /* Shadows */
            --shadow-glow: 0 0 12px rgba(103, 121, 95, 0.2); 
            --shadow-soft: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        /*
        ---------------------------------------------
        COLOR VARIABLES - DARK MODE (Applied when <html> has class="dark")
        ---------------------------------------------
        */
        html.dark {
            /* Inverted Palette Mappings */
            --bg-page: #1F1F1F;                 /* Deep Charcoal */
            --bg-surface: #292929;              /* Darker Surface */
            --text-primary: var(--color-secondary-light); /* Light Sage Accent */
            --text-main: #E0E0E0;               /* Light Gray */
            --text-muted: #A0A0A0;              /* Muted Gray */
            --border-light: #3D3D3D;            /* Dark Border */
            
            /* Shadows (Dark mode shadows should be subtle) */
            --shadow-glow: 0 0 12px rgba(175, 204, 192, 0.15); 
            --shadow-soft: 0 4px 10px rgba(0, 0, 0, 0.5); 
        }


        /* Apply Base Styles using variables */
        body {
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-page);
            color: var(--text-main); 
            scroll-behavior: smooth;
        }
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Playfair Display', serif; 
        }

        /* CARD STYLES */
        .cake-card {
            background-color: var(--bg-surface);
            transition: all 0.3s ease-in-out;
            border: 1px solid var(--border-light); 
            box-shadow: var(--shadow-soft);
            opacity: 0; /* Start hidden for stagger animation */
            transform: translateY(20px); 
        }

        /* CARD HOVER EFFECT */
        .cake-card:hover {
            box-shadow: var(--shadow-soft), var(--shadow-glow); 
            border-color: var(--text-primary); 
            transform: translateY(-5px) scale(1.02);
        }
        
        /* MODAL BACKDROP */
        .modal-backdrop {
            background-color: rgba(31, 31, 31, 0.9); 
            backdrop-filter: blur(10px); 
        }

        /* PRIMARY BUTTON STYLES (Sage/Primary Accent) */
        .sage-button {
            background-color: var(--text-primary);
            color: var(--bg-page); /* Contrast text against the primary accent */
            transition: all 0.2s ease-out; 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .sage-button:hover {
            background-color: var(--color-primary-dark); 
            box-shadow: 0 0 15px rgba(103, 121, 95, 0.5);
            transform: scale(1.02); 
        }
        .sage-button:active {
            transform: scale(0.98);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        /* Fix button text color for dark mode (Override Tailwind defaults) */
        html.dark .sage-button {
             color: #1F1F1F; /* Force dark text for contrast on light sage accent */
        }
        html.dark .sage-button:hover {
            background-color: #5A6953; 
            color: var(--color-bg-light); /* Light text on darker hover */
        }


        /* FROSTED HEADER EFFECT */
        .frosted-header {
            background-color: var(--bg-page);
            opacity: 0.98;
            backdrop-filter: blur(10px); 
            border-bottom-color: var(--border-light);
        }
        
        /* Form inputs look clean */
        input:focus, textarea:focus {
             --tw-ring-color: var(--text-primary) !important;
             border-color: var(--text-primary) !important;
        }

        /* Utility styles for forms and numbers (unchanged) */
        input[type="file"]::file-selector-button { display: none; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        
        /* Keyframe for entry animation */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeInUp {
            animation: fadeInUp 0.4s ease-out forwards;
        }
        
        /* Style for the D/L mode toggle text */
        .mode-text {
            font-size: 0.9rem;
            font-weight: 700;
            line-height: 1;
        }

    </style>
</head>
<body class="min-h-screen">

    <!-- Header Section -->
    <header class="frosted-header sticky top-0 z-20 border-b shadow-soft">
        <div class="max-w-7xl mx-auto py-4 px-6 sm:px-8 lg:px-10 flex justify-between items-center">
            <h1 class="text-4xl font-heading font-extrabold text-text-primary tracking-wider uppercase drop-shadow-sm flex-shrink-0">
                Bakes-Villa
            </h1>
            <!-- Admin & Mode Toggles -->
            <div class="flex items-center space-x-4">
                
                <!-- Dark Mode Toggle Button (D / L text) -->
                <button id="modeToggle" onclick="toggleDarkMode()" 
                        class="p-2 rounded-full transition duration-300 text-text-primary hover:bg-bg-surface border border-border-light hover:border-text-primary w-8 h-8 flex items-center justify-center">
                    <span id="modeText" class="mode-text">L</span>
                </button>

                <!-- Admin Toggle Button (Visible only when logged in) -->
                <div id="adminPanelToggle" class="hidden">
                    <button onclick="toggleAdminPanel()" class="text-text-primary hover:text-text-muted transition duration-150 text-sm flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-1">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-9.75 0h9.75" />
                        </svg>
                        Admin
                    </button>
                </div>
                <!-- Order Button: Sage Accent -->
                <a href="tel:9835243250" class="sage-button px-4 py-2 sm:px-5 sm:py-3 rounded-full font-heading font-semibold text-base sm:text-lg border border-text-primary flex items-center flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 sm:w-6 sm:h-6 inline-block mr-2 -mt-0.5">
                        <path fill-rule="evenodd" d="M1.5 4.5a3 3 0 0 1 3-3h1.368c1.08 0 2.114.54 2.778 1.484l.857 1.291c.31.465.424 1.05.282 1.583-.544 2.025-1.292 4.34-2.25 6.614a15.724 15.724 0 0 0 6.134 6.134c2.274-.958 4.589-1.706 6.614-2.25a1.867 1.867 0 0 1 1.583.282l1.291.857c.944.664 1.484 1.698 1.484 2.778V19.5a3 3 0 0 1-3 3h-2.25A16.5 16.5 0 0 1 2.25 6.75V4.5A3 3 0 0 1 1.5 1.5Z" clip-rule="evenodd" />
                    </svg>
                    Order Now
                </a>
            </div>
        </div>
    </header>

    <!-- Admin Panel (Hidden by default) -->
    <div id="adminPanel" class="hidden bg-bg-surface py-4 px-6 sm:px-8 lg:px-10 border-b border-border-light shadow-inner z-10 relative">
        <h3 class="text-xl font-heading font-semibold text-text-primary mb-3">Admin Panel: Add New Cake</h3>
        <p class="text-text-muted text-sm mb-4" id="adminStatus">Status: Not Authenticated</p>
        
        <form id="addCakeForm" class="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-4xl mx-auto p-4 bg-bg-page rounded-xl shadow-soft border border-border-light">
            <!-- Name -->
            <input type="text" id="cakeName" placeholder="Cake Name (e.g., Organic Honey Cake)" required
                   class="col-span-1 p-3 rounded-lg bg-bg-page border border-border-light text-text-main placeholder-text-muted focus:ring-text-primary focus:border-text-primary">
            
            <!-- Price - Changed to type="number" -->
            <input type="number" id="cakePrice" placeholder="Price (e.g., 950)" required
                   class="col-span-1 p-3 rounded-lg bg-bg-page border border-border-light text-text-main placeholder-text-muted focus:ring-text-primary focus:border-text-primary">
            
            <!-- Local Image Upload -->
            <label for="cakeImageFile" class="md:col-span-2 p-3 rounded-lg bg-bg-page border border-border-light text-text-muted cursor-pointer flex items-center focus-within:ring-text-primary focus-within:border-text-primary">
                <!-- Cupcake Icon -->
                <svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mr-2 text-text-primary">
                    <path d="M12 2C9.79 2 8 3.79 8 6v5h8V6c0-2.21-1.79-4-4-4zM16 13h-8c-1.1 0-2 .9-2 2v2c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2v-2c0-1.1-.9-2-2-2zM6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2v-1H6v1z" opacity=".3"/>
                    <path d="M16 13c1.1 0 2-.9 2-2V6c0-2.21-1.79-4-4-4S8 3.79 8 6v5c0 1.1.9 2 2 2h6zm-4-9c1.1 0 2 .9 2 2v3h-4V6c0-1.1.9-2 2-2zm-6 9v-1h-2v1c0 1.1.9 2 2 2v2c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2v-2c1.1 0 2-.9 2-2v-2h-2v1c0 1.1-.9 2-2 2H8c-1.1 0-2-.9-2-2z"/>
                </svg>
                <span id="fileLabelText">Select Image from Device (JPEG/PNG) *Required*</span>
                <input type="file" id="cakeImageFile" accept="image/jpeg, image/png" required
                       class="hidden">
            </label>

            <!-- Description -->
            <textarea id="cakeDescription" placeholder="Description (e.g., Made with organic whole wheat flour and natural sweeteners)" required
                      class="md:col-span-2 p-3 rounded-lg bg-bg-page border border-border-light text-text-main placeholder-text-muted focus:ring-text-primary focus:border-text-primary h-24"></textarea>

            <!-- Submit Button -->
            <button type="submit" id="addCakeButton" class="md:col-span-2 sage-button font-heading font-bold py-3 rounded-full text-lg">
                Add Cake to Catalog
            </button>
        </form>
        <p id="adminMessage" class="text-center mt-3 text-sm text-text-main"></p>
    </div>

    <!-- Main Gallery Section -->
    <main class="max-w-7xl mx-auto pt-28 pb-16 px-6 sm:px-8 lg:px-10">
        <h2 class="text-4xl sm:text-5xl font-heading font-extrabold text-text-primary mb-6 text-center leading-tight">
            <span class="drop-shadow-sm">Earthy & Healthful</span> Creations
        </h2>
        <p class="text-center text-text-muted text-lg sm:text-xl mb-16 max-w-3xl mx-auto leading-relaxed">
            Discover our organic, health-conscious snacks‚Äîdelicious and tempting for your ingredient savvy customers.
        </p>

        <!-- Cake Gallery Grid -->
        <div id="gallery" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8 sm:gap-10">
            <p class="md:col-span-3 text-center text-text-muted">Loading cakes...</p>
        </div>
    </main>

    <!-- Modal/Pop-up Structure (for cake details) -->
    <div id="cakeModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 modal-backdrop" onclick="closeModal(event)">
        <!-- Modal Content Container -->
        <div id="modalContent" class="bg-bg-surface rounded-3xl w-full max-w-lg overflow-hidden transform transition-all scale-90 opacity-0 duration-300 border border-border-light shadow-soft" onclick="event.stopPropagation()">
            
            <!-- Modal Header and Close Button -->
            <div class="flex justify-between items-center p-5 border-b border-border-light">
                <h3 id="modalTitle" class="text-2xl sm:text-3xl font-heading font-bold text-text-primary">Cake Name</h3>
                <button onclick="closeModal()" class="text-text-muted hover:text-text-primary transition duration-150 transform hover:scale-110 p-1 rounded-full hover:bg-bg-page/50">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-7 h-7">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                    </svg>                      
                </button>
            </div>

            <!-- Modal Body (Image and Details) -->
            <div class="p-6 sm:p-8">
                <img id="modalImage" src="" alt="Selected Cake" class="w-full h-56 sm:h-72 object-cover rounded-xl mb-6 shadow-soft border border-border-light" onerror="this.onerror=null;this.src='https://placehold.co/400x300/FFF3DF/67795F?text=Image+Missing';">
                <div class="flex justify-between items-center mb-4">
                    <p class="text-xl sm:text-2xl font-heading font-extrabold text-text-primary" id="modalPrice">‚Çπ000</p>
                </div>
                <p id="modalDescription" class="text-text-muted leading-relaxed text-base sm:text-lg mb-8">Cake description here.</p>

                <!-- Call to Action for both Call and WhatsApp -->
                <div class="space-y-4">
                    <!-- WhatsApp Button (Recommended for mobile ordering) -->
                    <a id="whatsappOrderLink" href="#" target="_blank" class="w-full block text-center bg-accent-green text-bg-light font-heading font-bold py-4 px-8 rounded-full sage-button text-lg flex items-center justify-center hover:bg-[#3CB371] border border-accent-green">
                        WhatsApp Order
                    </a>
                    
                    <!-- Call Button -->
                    <a href="tel:9835243250" class="w-full block text-center sage-button text-bg-light font-heading font-bold py-4 px-8 rounded-full border border-text-primary text-lg flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 inline-block mr-3 -mt-0.5">
                            <path fill-rule="evenodd" d="M1.5 4.5a3 3 0 0 1 3-3h1.368c1.08 0 2.114.54 2.778 1.484l.857 1.291c.31.465.424 1.05.282 1.583-.544 2.025-1.292 4.34-2.25 6.614a15.724 15.724 0 0 0 6.134 6.134c2.274-.958 4.589-1.706 6.614-2.25a1.867 1.867 0 0 1 1.583.282l1.291.857c.944.664 1.484 1.698 1.484 2.778V19.5a3 3 0 0 1-3 3h-2.25A16.5 16.5 0 0 1 2.25 6.75V4.5A3 3 0 0 1 1.5 1.5Z" clip-rule="evenodd" />
                        </svg>
                        Call to Order: 9835243250
                    </a>
                </div>
            </div>
            
            <p class="text-xs text-center text-text-muted py-3 border-t border-border-light">
                Reference ID: <span id="modalId" class="font-semibold text-text-main"></span>
            </p>
        </div>
    </div>
    
    <!-- Admin Login Modal -->
    <div id="loginModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 modal-backdrop" onclick="closeLoginModal(event)">
        <div id="loginModalContent" class="bg-bg-surface rounded-3xl w-full max-w-sm overflow-hidden transform transition-all scale-90 opacity-0 duration-300 border border-border-light shadow-soft" onclick="event.stopPropagation()">
            <div class="p-6">
                <h3 class="text-2xl font-heading font-bold text-text-primary text-center mb-6">Admin Login (AL)</h3>
                
                <form id="adminLoginFormModal" class="space-y-4">
                    <input type="text" id="adminUsernameModal" placeholder="Username" required
                           class="w-full p-3 rounded-lg bg-bg-page border border-border-light text-text-main placeholder-text-muted focus:ring-text-primary focus:border-text-primary">
                    
                    <input type="password" id="adminPasswordModal" placeholder="Password" required
                           class="w-full p-3 rounded-lg bg-bg-page border border-border-light text-text-main placeholder-text-muted focus:ring-text-primary focus:border-text-primary">
                    
                    <button type="submit" class="w-full sage-button font-heading font-bold py-3 rounded-full text-lg">
                        Login
                    </button>
                    <p id="loginMessage" class="text-center text-sm text-red-600 mt-2 h-4"></p>
                </form>
            </div>
        </div>
    </div>


    <!-- Footer with Admin Login Link -->
    <footer class="mt-16 py-6 bg-bg-surface/50 border-t border-border-light text-center text-text-muted">
        <p id="copyrightText" class="mb-2">
            <!-- This will be updated by JavaScript -->
        </p>
        <!-- The user will either see the Login link or the Logout link -->
        <button id="adminLoginLink" onclick="openLoginModal()" class="text-text-muted hover:text-text-primary transition duration-150 text-sm">
            Admin Login (AL)
        </button>
        <button id="adminLogoutLink" onclick="logoutAdmin()" class="hidden text-red-600 hover:text-red-400 transition duration-150 text-sm">
            Admin Logout
        </button>
    </footer>


    <!-- JavaScript Logic -->
    <script>
        // Set a global variable to hold the callback function
        window.onloadCallback = null;

        // Global Firebase instances and variables
        let app;
        let db;
        let auth;
        let userId = null;
        let isAdmin = false;
        let cakesCollectionRef;
        let currentMode = localStorage.getItem('theme') || 'system'; // Load theme from local storage

        // Element references
        const htmlElement = document.documentElement;
        const modeText = document.getElementById('modeText');
        const galleryEl = document.getElementById('gallery');
        const modalEl = document.getElementById('cakeModal');
        const adminPanelEl = document.getElementById('adminPanel');
        const addCakeForm = document.getElementById('addCakeForm');
        const adminMessageEl = document.getElementById('adminMessage');
        const fileLabelTextEl = document.getElementById('fileLabelText');
        const adminPanelToggleEl = document.getElementById('adminPanelToggle'); 
        const loginModalEl = document.getElementById('loginModal'); 
        const loginMessageEl = document.getElementById('loginMessage'); 
        const adminLoginLinkEl = document.getElementById('adminLoginLink'); 
        const adminLogoutLinkEl = document.getElementById('adminLogoutLink'); 
        const copyrightTextEl = document.getElementById('copyrightText'); 
        const whatsappOrderLinkEl = document.getElementById('whatsappOrderLink'); 


        // Modal content references
        const modalTitleEl = document.getElementById('modalTitle');
        const modalImageEl = document.getElementById('modalImage');
        const modalDescriptionEl = document.getElementById('modalDescription');
        const modalPriceEl = document.getElementById('modalPrice');
        const modalIdEl = document.getElementById('modalId');
        
        // --- DARK MODE LOGIC ---

        /**
         * Sets the current theme and saves it to local storage.
         */
        function applyTheme(mode) {
            if (mode === 'dark' || (mode === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                htmlElement.classList.add('dark');
                modeText.textContent = 'L'; // Show L (Light) option when currently Dark
                localStorage.setItem('theme', 'dark');
                currentMode = 'dark';
            } else {
                htmlElement.classList.remove('dark');
                modeText.textContent = 'D'; // Show D (Dark) option when currently Light
                localStorage.setItem('theme', 'light');
                currentMode = 'light';
            }
        }

        /**
         * Toggles between dark and light modes.
         */
        function toggleDarkMode() {
            if (currentMode === 'light' || currentMode === 'system') {
                applyTheme('dark');
            } else {
                applyTheme('light');
            }
        }

        // Apply theme immediately on load based on saved preference or system default
        applyTheme(currentMode);
        
        // Listen for system changes if the mode is set to 'system'
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            if (currentMode === 'system') {
                applyTheme('system');
            }
        });

        // --- ADMIN & AUTH FUNCTIONS ---
        const ADMIN_USERNAME = 'siddhijain';
        const ADMIN_PASSWORD = 'siddhijain123';
        const FAKE_ADMIN_UID = 'siddhijain-admin-0000'; 

        // --- IMAGE RESIZE/COMPRESSION UTILITY (UNCHANGED) ---
        /**
         * Resizes and compresses an image file into a Base64 string to fit Firestore limits.
         */
        function resizeImage(file, maxWidth = 800, quality = 0.8) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = event => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        if (width > maxWidth) {
                            height = height * (maxWidth / width);
                            width = maxWidth;
                        }

                        canvas.width = width;
                        canvas.height = height;

                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        const resizedBase64 = canvas.toDataURL('image/jpeg', quality);
                        
                        if (resizedBase64.length > 1398101) { 
                            reject(new Error("Image is still too large after compression."));
                        }

                        resolve(resizedBase64);
                    };
                    img.onerror = error => reject(error);
                };
                reader.onerror = error => reject(error);
            });
        }
        // --- END IMAGE RESIZE/COMPRESSION UTILITY ---

        // --- UI UTILITY FUNCTIONS (UNCHANGED) ---
        function updateFooterYear() {
            copyrightTextEl.textContent = `¬© ${new Date().getFullYear()} Bakes-Villa. All rights reserved.`;
        }

        function openLoginModal() {
            loginModalEl.classList.remove('hidden');
            loginModalEl.classList.add('flex');
            document.body.classList.add('overflow-hidden');
            loginMessageEl.textContent = '';
            document.getElementById('loginModalContent').classList.remove('scale-90', 'opacity-0');
            document.getElementById('loginModalContent').classList.add('scale-100', 'opacity-100');
        }

        function closeLoginModal(event) {
            if (event && event.target !== loginModalEl && !event.target.closest('button')) {
                return;
            }

            document.getElementById('loginModalContent').classList.remove('scale-100', 'opacity-100');
            document.getElementById('loginModalContent').classList.add('scale-90', 'opacity-0');
            
            setTimeout(() => {
                loginModalEl.classList.remove('flex');
                loginModalEl.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            }, 300);
        }
        
        function toggleAdminPanel() {
            if (!isAdmin) return;
            if (adminPanelEl.classList.contains('hidden')) {
                adminPanelEl.classList.remove('hidden');
            } else {
                adminPanelEl.classList.add('hidden');
            }
        }
        
        function updateAdminUI(isUserAdmin, id) {
            const adminStatusEl = document.getElementById('adminStatus');
            isAdmin = isUserAdmin;
            userId = id;
            
            if (isAdmin) {
                adminPanelToggleEl.classList.remove('hidden');
                adminLoginLinkEl.classList.add('hidden');
                adminLogoutLinkEl.classList.remove('hidden');
                adminStatusEl.textContent = `Status: Logged in as Admin (${userId.substring(0, 8)}...)`;
            } else {
                adminPanelToggleEl.classList.add('hidden');
                adminPanelEl.classList.add('hidden'); 
                adminLoginLinkEl.classList.remove('hidden');
                adminLogoutLinkEl.classList.add('hidden');
                adminStatusEl.textContent = `Status: Logged out (View Only)`;
            }
        }
        
        function handleAdminLogin(event) {
            event.preventDefault();
            const username = document.getElementById('adminUsernameModal').value;
            const password = document.getElementById('adminPasswordModal').value;
            
            loginMessageEl.textContent = '';

            if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                updateAdminUI(true, FAKE_ADMIN_UID);
                closeLoginModal();
                adminPanelEl.classList.remove('hidden'); 
                document.getElementById('adminLoginFormModal').reset();
            } else {
                loginMessageEl.textContent = 'Invalid credentials. Please try again.';
            }
        }
        
        function logoutAdmin() {
            updateAdminUI(false, crypto.randomUUID());
        }
        
        async function handleAddCake(event) {
            event.preventDefault();
            
            if (!isAdmin || !cakesCollectionRef) {
                adminMessageEl.textContent = "Error: Not authorized or database not ready.";
                return;
            }
            
            const { addDoc } = window.FirebaseServices;

            const name = document.getElementById('cakeName').value;
            const price = document.getElementById('cakePrice').value;
            const fileInput = document.getElementById('cakeImageFile');
            const description = document.getElementById('cakeDescription').value;
            const file = fileInput.files[0];
            
            const priceValue = parseFloat(price);
            if (isNaN(priceValue) || priceValue <= 0) {
                 adminMessageEl.textContent = "Please enter a valid price (only positive numbers allowed).";
                 return;
            }

            if (!file) {
                adminMessageEl.textContent = "Please select an image file.";
                return;
            }

            adminMessageEl.textContent = "Processing and resizing image...";

            try {
                const imageData = await resizeImage(file);

                const newCake = {
                    name,
                    price: `‚Çπ${priceValue.toFixed(0)}`,
                    imageData,
                    description,
                    createdAt: new Date().toISOString()
                };

                await addDoc(cakesCollectionRef, newCake);
                
                adminMessageEl.textContent = `Success! '${name}' added to the catalog.`;
                addCakeForm.reset();
                fileLabelTextEl.textContent = 'Select Image from Device (JPEG/PNG) *Required*';

            } catch (error) {
                console.error("Error adding document: ", error);
                adminMessageEl.textContent = `Error adding cake: ${error.message}. Please try a smaller image.`;
            }
        }
        
        // --- GALLERY/MODAL FUNCTIONS ---

        /**
         * Renders all cake cards into the gallery based on live data.
         */
        function renderGallery(liveCakes) {
            galleryEl.innerHTML = ''; 
            
            if (liveCakes.length === 0) {
                galleryEl.innerHTML = '<p class="md:col-span-3 text-center text-text-muted mt-8">No cakes available yet. The admin needs to add the first few!</p>';
                return;
            }

            liveCakes.forEach((cake, index) => {
                const imageSource = cake.imageData || "https://placehold.co/400x300/FFF3DF/67795F?text=Image+Missing";

                const card = document.createElement('div');
                // Added staggering delay for entry animation
                card.style.animationDelay = `${index * 0.1}s`; 
                card.classList.add(
                    'p-5', 'rounded-3xl', 'cursor-pointer', 'group',
                    'cake-card', 
                    'hover:z-10',
                    'animate-fadeInUp' // Custom class for entry animation
                );
                card.setAttribute('data-cake-id', cake.id);
                card.onclick = () => openModal(cake); 

                card.innerHTML = `
                    <img src="${imageSource}" alt="${cake.name}" 
                         class="w-full h-56 object-cover rounded-2xl mb-4 transition-transform duration-300 ease-in-out border border-border-light">
                    <div class="relative z-10 text-center">
                        <h3 class="text-2xl font-heading font-semibold text-text-main mb-1 truncate">${cake.name}</h3>
                        <p class="text-text-primary font-bold text-xl">${cake.price}</p>
                    </div>
                `;
                galleryEl.appendChild(card);
                
                // Trigger animation after adding to DOM
                setTimeout(() => {
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, 10);
            });
        }


        /**
         * Opens the modal with the details of the selected cake.
         */
        function openModal(cake) {
            const imageSource = cake.imageData || "https://placehold.co/400x300/FFF3DF/67795F?text=Image+Missing";
            
            modalTitleEl.textContent = cake.name;
            modalImageEl.src = imageSource;
            modalImageEl.alt = cake.name;
            modalDescriptionEl.textContent = cake.description;
            modalPriceEl.textContent = cake.price;
            modalIdEl.textContent = `#${cake.id.substring(0, 8)}`;
            
            // --- WHATSAPP LINK GENERATION ---
            const message = encodeURIComponent(
                `Hello Bakes-Villa! I would like to place an order for the following cake:\n\n` +
                `Cake Name: ${cake.name}\n` +
                `Price: ${cake.price}\n` +
                `Reference ID: ${cake.id.substring(0, 8)}\n\n` +
                `Please let me know the process for confirming the order and delivery details. Thank you!`
            );
            whatsappOrderLinkEl.href = `https://wa.me/919835243250?text=${message}`;
            // --- END WHATSAPP LINK GENERATION ---

            modalEl.classList.remove('hidden');
            modalEl.classList.add('flex');
            document.body.classList.add('overflow-hidden'); 

            setTimeout(() => {
                document.getElementById('modalContent').classList.remove('scale-90', 'opacity-0');
                document.getElementById('modalContent').classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        /**
         * Closes the modal.
         */
        function closeModal(event) {
            if (event && event.target !== modalEl && !event.target.closest('button')) {
                return; 
            }

            document.getElementById('modalContent').classList.remove('scale-100', 'opacity-100');
            document.getElementById('modalContent').classList.add('scale-90', 'opacity-0');

            setTimeout(() => {
                modalEl.classList.remove('flex');
                modalEl.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            }, 300); 
        }

        // --- FIREBASE INITIALIZATION (CRITICALLY REVISED) ---

        /**
         * Parses config from global environment variables.
         */
        function getConfig() {
            const rawConfig = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
            if (!rawConfig) return null;
            try {
                const config = JSON.parse(rawConfig);
                return (Object.keys(config).length > 0) ? config : null;
            } catch (e) {
                console.error("Error parsing __firebase_config:", e);
                return null;
            }
        }

        async function initializeFirebase() {
            if (typeof window.FirebaseServices === 'undefined') {
                setTimeout(initializeFirebase, 100);
                return;
            }
            
            const { 
                initializeApp, getAuth, signInAnonymously, signInWithCustomToken, 
                onAuthStateChanged, getFirestore, onSnapshot, collection, setLogLevel 
            } = window.FirebaseServices;

            const firebaseConfig = getConfig();
            
            if (!firebaseConfig) {
                 console.error("FATAL ERROR: Firebase configuration is missing or invalid. Displaying static error.");
                 galleryEl.innerHTML = `<p class="md:col-span-3 text-center text-red-600 mt-8">ERROR: Could not connect to the database. Check console for details.</p>`;
                 return; 
            }

            try {
                // Initialize Core Services
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug'); 
                
                // 1. Handle Authentication Flow
                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                // Use the onAuthStateChanged listener to handle initial and subsequent state changes
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // User is signed in (either via token or anonymously)
                        updateAdminUI(!!token, user.uid); // Assume admin if platform token was present
                    } else if (token) {
                        // If token is present but user isn't signed in, use the token
                        await signInWithCustomToken(auth, token).catch(e => {
                            console.warn("Custom token sign-in failed, proceeding with anonymous.", e);
                            signInAnonymously(auth);
                        });
                    } else {
                        // No token, sign in anonymously
                        signInAnonymously(auth);
                    }
                    
                    // 2. Setup Firestore Listener (must happen after auth completes initial check)
                    setupFirestoreListener(onSnapshot, collection); 
                });

                // 3. Attach Event Listeners
                addCakeForm.addEventListener('submit', handleAddCake);
                document.getElementById('adminLoginFormModal').addEventListener('submit', handleAdminLogin);

                document.getElementById('cakeImageFile').addEventListener('change', (e) => {
                    const fileName = e.target.files[0] ? e.target.files[0].name : 'Select Image from Device (JPEG/PNG) *Required*';
                    fileLabelTextEl.textContent = fileName;
                });
                
                updateFooterYear();

            } catch (error) {
                console.error("Firebase Initialization or Auth Failed:", error);
                galleryEl.innerHTML = `<p class="md:col-span-3 text-center text-red-600 mt-8">ERROR: Could not connect to the database. Check console for details.</p>`;
            }
        }

        /**
         * Sets up a real-time listener for the public cakes collection.
         */
        function setupFirestoreListener(onSnapshot, collection) {
            if (!db) return; 

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            cakesCollectionRef = collection(db, `artifacts/${appId}/public/data/cakes`);
            
            onSnapshot(cakesCollectionRef, (snapshot) => {
                const liveCakes = [];
                snapshot.forEach(doc => {
                    liveCakes.push({ id: doc.id, ...doc.data() });
                });
                
                liveCakes.sort((a, b) => (a.name || "").localeCompare(b.name || ""));
                
                renderGallery(liveCakes);
            }, (error) => {
                console.error("Error fetching cakes:", error);
                galleryEl.innerHTML = `<p class="md:col-span-3 text-center text-red-600 mt-8">Error loading catalog: ${error.message}</p>`;
            });
        }

        // Use a global callback to ensure initialization happens after the module script loads.
        window.onloadCallback = initializeFirebase;
    </script>

</body>
</html>
